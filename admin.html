<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InnoDIGI License Admin</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="quill.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
            </div>
            <h1>InnoDIGI License Admin</h1>
            <p>Beheer licenties en instellingen voor InnoDIGI applicaties</p>
        </div>

        <!-- Messages -->
        <div id="successMessage" class="message success hidden">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span id="successText"></span>
        </div>

        <div id="errorMessage" class="message error hidden">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            <span id="errorText"></span>
        </div>

        <!-- Statistics -->
        <div id="statsContainer" class="stats-grid">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Admin Key Input -->
        <div class="card" id="adminKeyCard">
            <div class="card-header">
                <div class="card-header-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3.586l7.257-7.257C11.743 7.673 14.307 6 17 6a4 4 0 014 4z"/>
                    </svg>
                </div>
                <h2>Admin Toegang</h2>
                <p>Voer de admin sleutel in om toegang te krijgen</p>
            </div>
            <div class="form-group">
                <div class="form-field">
                    <label for="adminKey">Admin Sleutel:</label>
                    <input type="password" id="adminKey" placeholder="Voer admin sleutel in">
                </div>
                <button type="button" class="btn btn-primary btn-full" onclick="authenticateAdmin()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                    </svg>
                    Inloggen
                </button>
            </div>
        </div>

        <!-- Admin Content -->
        <div id="adminContent" class="hidden">
            <!-- Create License Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 4v16m8-8H4"/>
                        </svg>
                    </div>
                    <h2>Nieuwe Licentie Aanmaken</h2>
                    <p>Maak een nieuwe licentie aan voor een klant</p>
                </div>
                <form id="createLicenseForm">
                    <div class="form-group">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newLicenseKey">Licentie Sleutel (optioneel):</label>
                                <input type="text" id="newLicenseKey" placeholder="Laat leeg voor automatische generatie">
                                <div class="form-help">Als leeg gelaten wordt automatisch een sleutel gegenereerd (ID-XXXXXXXX-XXXXXXXX)</div>
                            </div>
                            <div class="form-field">
                                <label for="newLicenseType">Licentie Type:</label>
                                <select id="newLicenseType">
                                    <option value="">Licentietypes laden...</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newCustomerName">Klant Naam:</label>
                                <input type="text" id="newCustomerName" placeholder="Naam van de klant">
                            </div>
                            <div class="form-field">
                                <label for="newCustomerEmail">Klant Email:</label>
                                <input type="email" id="newCustomerEmail" placeholder="email@voorbeeld.nl">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newExpiresAt">Verloopt op (optioneel):</label>
                                <input type="datetime-local" id="newExpiresAt">
                                <div class="form-help">Laat leeg voor geen vervaldatum. Trial licenties vervallen automatisch na 30 dagen.</div>
                            </div>
                            <div class="form-field">
                                <label for="newNotes">Notities:</label>
                                <input type="text" id="newNotes" placeholder="Extra notities (optioneel)">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-full">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 4v16m8-8H4"/>
                        </svg>
                        Licentie Aanmaken
                    </button>
                </form>
            </div>

            <!-- License Management Section -->
            <div class="card">
                <div class="card-header">
                    <div class="table-header">
                        <div>
                            <h2>Licentie Beheer</h2>
                            <p>Bekijk en beheer alle licenties</p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="loadLicenses()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Vernieuwen
                        </button>
                    </div>
                </div>
                
                <!-- Search and Filter -->
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Zoek op licentie sleutel, klant naam, email...">
                    </div>
                    <div class="filter-buttons">
                        <button type="button" class="filter-btn active" data-status="all">Alle</button>
                        <button type="button" class="filter-btn" data-status="active">Actief</button>
                        <button type="button" class="filter-btn" data-status="inactive">Inactief</button>
                        <button type="button" class="filter-btn" data-status="expired">Verlopen</button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table id="licensesTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="license_key">Licentie Sleutel</th>
                                <th class="sortable" data-sort="license_type">Type</th>
                                <th class="sortable" data-sort="customer_name">Klant</th>
                                <th class="sortable" data-sort="status">Status</th>
                                <th class="sortable" data-sort="expires_at">Verloopt</th>
                                <th class="sortable" data-sort="created_at">Aangemaakt</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody id="licensesTableBody">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                    Licenties laden...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination-controls">
                    <div class="pagination-info">
                        Pagina <span id="currentPage">1</span> van <span id="totalPages">1</span> (totaal <span id="totalLicenses">0</span> licenties)
                    </div>
                    <div class="pagination-buttons">
                        <button type="button" class="pagination-btn" id="prevPageBtn">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 19l-7-7 7-7"/>
                            </svg>
                            Vorige
                        </button>
                        <div class="page-numbers" id="pageNumbers"></div>
                        <button type="button" class="pagination-btn" id="nextPageBtn">
                            Volgende
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Cards -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <h2>Instellingen</h2>
                    <p>Beheer licentietypes en andere instellingen</p>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-ghost btn-full mb-2" onclick="showLicenseTypesModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        Licentie Types Beheren
                    </button>
                    <button type="button" class="btn btn-ghost btn-full mb-2" onclick="showEmailTemplateModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        E-mail Template Bewerken
                    </button>
                    <button type="button" class="btn btn-ghost btn-full" onclick="showSMTPSettingsModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                        </svg>
                        SMTP Instellingen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit License Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Licentie Bewerken</h3>
                <p>Bewerk de details van deze licentie</p>
            </div>
            <form id="editLicenseForm">
                <div class="form-group">
                    <div class="form-field">
                        <label>Licentie Sleutel:</label>
                        <input type="text" id="editLicenseKey" readonly class="font-mono">
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="editLicenseType">Licentie Type:</label>
                            <select id="editLicenseType">
                                <!-- Options will be populated -->
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="editStatus">Status:</label>
                            <select id="editStatus">
                                <option value="active">Actief</option>
                                <option value="inactive">Inactief</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="editCustomerName">Klant Naam:</label>
                            <input type="text" id="editCustomerName">
                        </div>
                        <div class="form-field">
                            <label for="editCustomerEmail">Klant Email:</label>
                            <input type="email" id="editCustomerEmail">
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="editExpiresAt">Verloopt op:</label>
                        <input type="datetime-local" id="editExpiresAt">
                        <div class="form-help">Trial licenties vervallen automatisch na 30 dagen</div>
                    </div>
                    <div class="form-field">
                        <label for="editNotes">Notities:</label>
                        <input type="text" id="editNotes">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Annuleren</button>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <h3>Licentie Verwijderen</h3>
                <p>Weet je zeker dat je deze licentie wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.</p>
                <div class="font-mono text-sm" id="deleteConfirmKey"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')">Annuleren</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Verwijderen
                </button>
            </div>
        </div>
    </div>

    <script src="quill.min.js"></script>
    <script>
        let adminKey = '';
        let licenses = [];
        let licenseTypes = {};
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortField = 'created_at';
        let sortDirection = 'desc';
        let searchTerm = '';
        let statusFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus admin key input
            document.getElementById('adminKey').focus();
            
            // Handle enter key in admin key input
            document.getElementById('adminKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticateAdmin();
                }
            });
            
            // Setup form handlers
            setupFormHandlers();
            setupSearchAndFilter();
            setupPagination();
        });

        async function authenticateAdmin() {
            const key = document.getElementById('adminKey').value;
            
            if (!key) {
                showError('Voer een admin sleutel in');
                return;
            }
            
            // Test admin key by trying to get license types
            try {
                const response = await fetch('index.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'admin',
                        sub_action: 'get_license_types',
                        admin_key: key
                    })
                });
                
                if (response.ok) {
                    adminKey = key;
                    document.getElementById('adminKeyCard').classList.add('hidden');
                    document.getElementById('adminContent').classList.remove('hidden');
                    
                    // Load initial data
                    await Promise.all([
                        loadLicenseTypes(),
                        loadLicenses(),
                        loadStats()
                    ]);
                    
                    showSuccess('Succesvol ingelogd!');
                } else {
                    showError('Ongeldige admin sleutel');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showError('Fout bij inloggen');
            }
        }

        async function loadLicenseTypes() {
            try {
                const response = await fetch('index.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'admin',
                        sub_action: 'get_license_types',
                        admin_key: adminKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.license_types) {
                    licenseTypes = data.license_types;
                    populateLicenseTypeDropdowns();
                } else {
                    console.error('Failed to load license types:', data);
                    showError('Fout bij laden licentietypes');
                }
            } catch (error) {
                console.error('Error loading license types:', error);
                showError('Fout bij laden licentietypes');
            }
        }

        function populateLicenseTypeDropdowns() {
            const dropdowns = ['newLicenseType', 'editLicenseType'];
            
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;
                
                dropdown.innerHTML = '';
                
                // Add empty option for new license
                if (dropdownId === 'newLicenseType') {
                    dropdown.innerHTML = '<option value="">Selecteer licentie type</option>';
                }
                
                // Add license types
                Object.entries(licenseTypes).forEach(([key, value]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value;
                    dropdown.appendChild(option);
                });
            });
        }

        async function loadLicenses() {
            try {
                const response = await fetch('index.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'admin',
                        sub_action: 'list',
                        admin_key: adminKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    licenses = data.licenses || [];
                    renderLicensesTable();
                    loadStats();
                } else {
                    showError(data.error || 'Fout bij laden licenties');
                }
            } catch (error) {
                console.error('Error loading licenses:', error);
                showError('Fout bij laden licenties');
            }
        }

        async function loadStats() {
            const stats = {
                total: licenses.length,
                active: licenses.filter(l => l.status === 'active').length,
                inactive: licenses.filter(l => l.status === 'inactive').length,
                expired: licenses.filter(l => l.expires_at && new Date(l.expires_at) < new Date()).length
            };
            
            renderStats(stats);
        }

        function renderStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon blue">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <p>Totaal Licenties</p>
                            <p>${stats.total}</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon green">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <p>Actieve Licenties</p>
                            <p>${stats.active}</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon red">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <p>Inactieve Licenties</p>
                            <p>${stats.inactive}</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-icon yellow">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <p>Verlopen Licenties</p>
                            <p>${stats.expired}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLicensesTable() {
            const tbody = document.getElementById('licensesTableBody');
            
            if (licenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <h3>Geen licenties gevonden</h3>
                            <p>Er zijn nog geen licenties aangemaakt</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Filter and search licenses
            let filteredLicenses = licenses;
            
            // Apply search filter
            if (searchTerm) {
                filteredLicenses = filteredLicenses.filter(license => 
                    license.license_key.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (license.customer_name && license.customer_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (license.customer_email && license.customer_email.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredLicenses = filteredLicenses.filter(license => {
                    if (statusFilter === 'expired') {
                        return license.expires_at && new Date(license.expires_at) < new Date();
                    }
                    return license.status === statusFilter;
                });
            }
            
            // Apply sorting
            filteredLicenses.sort((a, b) => {
                let aVal = a[sortField] || '';
                let bVal = b[sortField] || '';
                
                if (sortField === 'created_at' || sortField === 'expires_at') {
                    aVal = new Date(aVal || 0);
                    bVal = new Date(bVal || 0);
                }
                
                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Pagination
            const totalItems = filteredLicenses.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedLicenses = filteredLicenses.slice(startIndex, endIndex);
            
            // Update pagination info
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalLicenses').textContent = totalItems;
            
            // Render table rows
            tbody.innerHTML = paginatedLicenses.map(license => {
                const isExpired = license.expires_at && new Date(license.expires_at) < new Date();
                const expiresDisplay = license.expires_at ? 
                    new Date(license.expires_at).toLocaleString('nl-NL') : 
                    'Geen';
                const createdDisplay = new Date(license.created_at).toLocaleString('nl-NL');
                const licenseTypeDisplay = licenseTypes[license.license_type] || license.license_type;
                
                let statusBadge = '';
                if (isExpired) {
                    statusBadge = '<span class="badge yellow">Verlopen</span>';
                } else if (license.status === 'active') {
                    statusBadge = '<span class="badge green">Actief</span>';
                } else {
                    statusBadge = '<span class="badge red">Inactief</span>';
                }
                
                return `
                    <tr>
                        <td class="font-mono">${license.license_key}</td>
                        <td>${licenseTypeDisplay}</td>
                        <td>
                            <div>${license.customer_name || '-'}</div>
                            ${license.customer_email ? `<div class="text-sm" style="color: #6b7280;">${license.customer_email}</div>` : ''}
                        </td>
                        <td>${statusBadge}</td>
                        <td>${expiresDisplay}</td>
                        <td>${createdDisplay}</td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn btn-sm btn-ghost" onclick="editLicense('${license.license_key}')" title="Bewerken">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                ${license.customer_email ? `
                                <button type="button" class="btn btn-sm btn-ghost" onclick="sendLicenseEmail('${license.license_key}')" title="E-mail verzenden">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                                ` : ''}
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteLicense('${license.license_key}')" title="Verwijderen">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updatePaginationButtons();
        }

        function setupFormHandlers() {
            // Create license form
            document.getElementById('createLicenseForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    action: 'admin',
                    sub_action: 'create',
                    admin_key: adminKey,
                    license_key: document.getElementById('newLicenseKey').value.trim(),
                    license_type: document.getElementById('newLicenseType').value,
                    customer_name: document.getElementById('newCustomerName').value.trim(),
                    customer_email: document.getElementById('newCustomerEmail').value.trim(),
                    expires_at: document.getElementById('newExpiresAt').value || null,
                    notes: document.getElementById('newNotes').value.trim()
                };
                
                if (!formData.license_type) {
                    showError('Selecteer een licentie type');
                    return;
                }
                
                try {
                    const response = await fetch('index.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showSuccess(`Licentie succesvol aangemaakt: ${data.license_key}`);
                        this.reset();
                        loadLicenses();
                    } else {
                        showError(data.error || 'Fout bij aanmaken licentie');
                    }
                } catch (error) {
                    console.error('Error creating license:', error);
                    showError('Fout bij aanmaken licentie');
                }
            });
            
            // Edit license form
            document.getElementById('editLicenseForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    action: 'admin',
                    sub_action: 'update',
                    admin_key: adminKey,
                    license_key: document.getElementById('editLicenseKey').value,
                    license_type: document.getElementById('editLicenseType').value,
                    status: document.getElementById('editStatus').value,
                    customer_name: document.getElementById('editCustomerName').value.trim(),
                    customer_email: document.getElementById('editCustomerEmail').value.trim(),
                    expires_at: document.getElementById('editExpiresAt').value || null,
                    notes: document.getElementById('editNotes').value.trim()
                };
                
                try {
                    const response = await fetch('index.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showSuccess('Licentie succesvol bijgewerkt');
                        closeModal('editModal');
                        loadLicenses();
                    } else {
                        showError(data.error || 'Fout bij bijwerken licentie');
                    }
                } catch (error) {
                    console.error('Error updating license:', error);
                    showError('Fout bij bijwerken licentie');
                }
            });
        }

        function setupSearchAndFilter() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                searchTerm = this.value;
                currentPage = 1;
                renderLicensesTable();
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    statusFilter = this.dataset.status;
                    currentPage = 1;
                    renderLicensesTable();
                });
            });
            
            // Table sorting
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const field = this.dataset.sort;
                    
                    if (sortField === field) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortField = field;
                        sortDirection = 'desc';
                    }
                    
                    // Update sort indicators
                    document.querySelectorAll('th.sortable').forEach(header => {
                        header.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    this.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    renderLicensesTable();
                });
            });
        }

        function setupPagination() {
            document.getElementById('prevPageBtn').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderLicensesTable();
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', function() {
                const totalPages = Math.ceil(licenses.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderLicensesTable();
                }
            });
        }

        function updatePaginationButtons() {
            const totalPages = Math.ceil(licenses.length / itemsPerPage);
            
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
            
            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderLicensesTable();
                };
                pageNumbers.appendChild(pageBtn);
            }
        }

        function editLicense(licenseKey) {
            const license = licenses.find(l => l.license_key === licenseKey);
            if (!license) return;
            
            document.getElementById('editLicenseKey').value = license.license_key;
            document.getElementById('editLicenseType').value = license.license_type;
            document.getElementById('editStatus').value = license.status;
            document.getElementById('editCustomerName').value = license.customer_name || '';
            document.getElementById('editCustomerEmail').value = license.customer_email || '';
            document.getElementById('editNotes').value = license.notes || '';
            
            // Handle expires_at
            if (license.expires_at) {
                const date = new Date(license.expires_at);
                const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
                document.getElementById('editExpiresAt').value = localDateTime.toISOString().slice(0, 16);
            } else {
                document.getElementById('editExpiresAt').value = '';
            }
            
            showModal('editModal');
        }

        function deleteLicense(licenseKey) {
            document.getElementById('deleteConfirmKey').textContent = licenseKey;
            window.licenseToDelete = licenseKey;
            showModal('deleteModal');
        }

        async function confirmDelete() {
            const licenseKey = window.licenseToDelete;
            
            try {
                const response = await fetch('index.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'admin',
                        sub_action: 'delete',
                        admin_key: adminKey,
                        license_key: licenseKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('Licentie succesvol verwijderd');
                    closeModal('deleteModal');
                    loadLicenses();
                } else {
                    showError(data.error || 'Fout bij verwijderen licentie');
                }
            } catch (error) {
                console.error('Error deleting license:', error);
                showError('Fout bij verwijderen licentie');
            }
        }

        async function sendLicenseEmail(licenseKey) {
            try {
                const response = await fetch('index.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'admin',
                        sub_action: 'send_license_email',
                        admin_key: adminKey,
                        license_key: licenseKey
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess('E-mail succesvol verzonden');
                } else {
                    showError(data.error || 'Fout bij verzenden e-mail');
                }
            } catch (error) {
                console.error('Error sending email:', error);
                showError('Fout bij verzenden e-mail');
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Message functions
        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            document.getElementById('successText').textContent = message;
            successMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 5000);
        }

        function showError(message) {
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            document.getElementById('errorText').textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
            
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        // Placeholder functions for settings modals
        function showLicenseTypesModal() {
            alert('License types modal - to be implemented');
        }

        function showEmailTemplateModal() {
            alert('Email template modal - to be implemented');
        }

        function showSMTPSettingsModal() {
            alert('SMTP settings modal - to be implemented');
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>